---
title: socket5 通信原理
date: 2019-01-18 09:22:40
[comment]: <> (文章简介，列表页显示)
introduction: socket5 通信原理
[comment]: <> - tagName
tag:
- Socket
[comment]: <> [tagName1, tagName2]
tags: [Socket]
layout: post
project: false
[comment]: <> image url
feature: 
comments: true
---

### 前言

socket5同时支持 `TCP` `UDP`协议。socket5一个完整的通信分为三个阶段：验证、建立连接和数据包转发。

### 验证

验证就是客户端发送一个验证请求，并告诉服务器端自己支持的验证方式。

```
+----------------+-----------------------------+------------------------+
| VER: 协议版本  | NMETHODS: 支持的验证方式数量 | METHODS: 选择的验证方式 |
+----------------+-----------------------------+------------------------+
| 0x05 (socket5) | 0x01                        | 0x00 (1 ~ 255个)       |
+----------------+-----------------------------+------------------------+
```

> 目前定义的验证方式有：
> 
> `0x00` NO AUTHENTICATION REQUIRED (无需验证)
> 
> `0x01` GSSAPI (通用安全服务应用程序接口)
> 
> `0x02` USERNAME/PASSWORD (用户名/密码)
> 
> `0x03` ~ `0x7F` IANA ASSIGNED (IANA 分配)
> 
> `0x80` ~ `0xFE` RESERVED FOR PRIVATE METHODS (私人方法保留)
> 
> `0xFF` NO ACCEPTABLE METHODS (无可接受方法)

服务器接收到上面的数据，选择自己支持的验证方式，并返回数据给客户端。

```
+---------------------------+------------------------------------+
| VER (协议版本)             | METHOD (选择的验证方式)               |
+---------------------------+------------------------------------+
| 0x05 (socket5)            | 0x00                               |
+---------------------------+------------------------------------+
```

除了无需验证，其他验证方式都需要子协议来验证。

### 建立连接

服务器返回自己的验证方式后，客户端会发起建立连接的请求。

```
+------+-----+------------+------+------------------+-------------------+
| VER  | CMD |RSV(保留字段)| ATYP | DST.ADDR(地址数据) | DST.PORT(端口数据) |
+------+-----+------------+------+------------------+-------------------+
| 0x05 | 0x01| 0x00       | 0x03 | 字节数据 (可变长度) | 字节数据 (2个字节)  |
+------+-----+------------+------+------------------+-------------------+
```

> CMD (请求类型)有：
> 
> `0x01` CONNECT (建立连接请求)
> 
> `0x02` BIND (绑定请求)
> 
> `0x03` UDP ASSOCIATE (UDP 协议请求)

> ATYP (地址类型)有：
> 
> `0x01` IP v4
> 
> `0x03` 域名，第一个字节表示域名的字节数，没有空字节。地址之后的两位字节才是端口号。
> 
> `0x04` IP v6

服务器接收到请求后，会根据 `DST.ADDR` 和 `DST.PORT` 创建连接目标地址的socket。并返回数据告诉客户端，连接建立的状态。

```
+------+----------+------+------+-------------------+-----------------+
| VER  |REP(状态码)| RSV  | ATYP | BND.ADDR(绑定地址) |BND.PORT(绑定端口) |
+------+----------+------+------+-------------------+-----------------+
| 0x05 | 0x00     | 0x00 | 0x03 | 字节数据 (可变长度) | 字节数据 (2个字节) |
+------+----------+------+------+-------------------+-----------------+
```

> REP 的值有：
> 
> `0x00` succeeded
> 
> `0x01` general SOCKS server failure
> 
> `0x02` connection not allowed by ruleset
> 
> `0x03` Network unreachable
> 
> `0x04` Host unreachable
> 
> `0x05` Connection refused
> 
> `0x06` TTL expired
> 
> `0x07` Command not supported
> 
> `0x08` Address type not supported
> 
> `0x09` ~ `0xFF` unassigned

至此，完整的socket连接已经建立完成，这时就可以从客户端接收数据（数据解析、数据加密、数据混淆等等），并且转发到目标服务器了。

### 数据转发

如果是 `TCP` 协议数据就直接发送给目标服务器，如果是 `UDP` 协议数据还需要对数据进一步处理。

`UDP` 数据处理，未完待续...

### 参考链接

[rfc1928](https://www.ietf.org/rfc/rfc1928.txt)